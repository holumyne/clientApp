{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/olumi/Desktop/ECommerce/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { firstValueFrom } from 'rxjs';\nimport { loadStripe } from '@stripe/stripe-js';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/basket/basket.service\";\nimport * as i2 from \"../checkout.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"../../shared/components/text-input/text-input.component\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\nfunction CheckoutPaymentComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 7)(1, \"div\", 8)(2, \"div\", 9);\n    i0.ɵɵelement(3, \"app-text-input\", 10);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 11)(5, \"div\", 12)(6, \"div\", 13);\n    i0.ɵɵelement(7, \"div\", 14, 15);\n    i0.ɵɵelementStart(9, \"label\");\n    i0.ɵɵtext(10, \"Card Number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"span\", 16);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 17)(14, \"div\", 13);\n    i0.ɵɵelement(15, \"div\", 14, 18);\n    i0.ɵɵelementStart(17, \"label\");\n    i0.ɵɵtext(18, \"Card Expiry\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(19, \"div\", 17)(20, \"div\", 13);\n    i0.ɵɵelement(21, \"div\", 14, 19);\n    i0.ɵɵelementStart(23, \"label\");\n    i0.ɵɵtext(24, \"Card CVC\");\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.checkoutForm);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"label\", \"Name on card\");\n    i0.ɵɵadvance(9);\n    i0.ɵɵtextInterpolate(ctx_r0.cardErrors);\n  }\n}\nfunction CheckoutPaymentComponent_i_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 20);\n  }\n}\nexport class CheckoutPaymentComponent {\n  constructor(basketService, checkoutService, toastr, router) {\n    this.basketService = basketService;\n    this.checkoutService = checkoutService;\n    this.toastr = toastr;\n    this.router = router;\n    this.stripe = null;\n    this.cardNumberComplete = false;\n    this.cardExpiryComplete = false;\n    this.cardCvcComplete = false;\n    this.loading = false;\n  }\n  ngOnInit() {\n    loadStripe('pk_test_51Nc0ASDNqK1yTqV4J0A4u2HDd8sYLikpqxlr7CVA7RDM8oatAyj1RQIiwbuccTUcSYyZAitKbEZhy2k9zoXxD76X00IprdA2L6').then(stripe => {\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {\n          this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n        this.cardCvc = elements.create('cardCvc');\n        this.cardCvc.mount(this.cardCvcElement?.nativeElement);\n        this.cardCvc.on('change', event => {\n          this.cardCvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n      }\n    });\n  }\n  get paymentFormComplete() {\n    return this.checkoutForm?.get('paymentForm')?.valid && this.cardNumberComplete && this.cardExpiryComplete && this.cardCvcComplete;\n  }\n  submitOrder() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      _this.loading = true; //loading indicator turn on\n      const basket = _this.basketService.getCurrentBasketValue();\n      //if (!basket) throw new Error('cannot get basket');\n      try {\n        const createdOrder = yield _this.createOrder(basket);\n        const paymentResult = yield _this.confirmPaymentWithStripe(basket);\n        if (paymentResult.paymentIntent) {\n          _this.basketService.deleteBasket(a); //this will delete the basket from Redis and local as well\n          const navigationExtras = {\n            state: createdOrder\n          };\n          _this.router.navigate(['checkout/success'], navigationExtras);\n        } else {\n          _this.toastr.error(paymentResult.error.message);\n        }\n      } catch (error) {\n        console.log(error);\n        _this.toastr.error(error.message);\n      } finally {\n        _this.loading = false; //loading indicator turn off\n      }\n    })();\n  }\n\n  confirmPaymentWithStripe(basket) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('Basket is null');\n      const result = _this2.stripe?.confirmCardPayment(basket.clientSecret, {\n        payment_method: {\n          card: _this2.cardNumber,\n          billing_details: {\n            name: _this2.checkoutForm?.get('paymentForm')?.get('nameOnCard')?.value\n          }\n        }\n      });\n      if (!result) throw new Error('Problem attempting payment with stripe');\n      return result;\n    })();\n  }\n  createOrder(basket) {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      if (!basket) throw new Error('Basket is null');\n      const orderToCreate = _this3.getOrderToCreate(basket);\n      return firstValueFrom(_this3.checkoutService.createOrder(orderToCreate));\n    })();\n  }\n  getOrderToCreate(basket) {\n    const deliveryMethodId = this.checkoutForm?.get('deliveryForm')?.get('deliveryMethod')?.value;\n    const shipToAddress = this.checkoutForm?.get('addressForm')?.value;\n    if (!deliveryMethodId || !shipToAddress) throw new Error('Problem with basket');\n    return {\n      basketId: basket.id,\n      deliveryMethodId: deliveryMethodId,\n      shipToAddress: shipToAddress\n    };\n  }\n}\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n  return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n};\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CheckoutPaymentComponent,\n  selectors: [[\"app-checkout-payment\"]],\n  viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n      i0.ɵɵviewQuery(_c1, 5);\n      i0.ɵɵviewQuery(_c2, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardCvcElement = _t.first);\n    }\n  },\n  inputs: {\n    checkoutForm: \"checkoutForm\"\n  },\n  decls: 9,\n  vars: 3,\n  consts: [[\"class\", \"mt-4\", 3, \"formGroup\", 4, \"ngIf\"], [1, \"d-flex\", \"justify-content-between\", \"flex-row\", \"mt-3\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-outline-primary\"], [1, \"fa\", \"fa-angle-left\"], [1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], [1, \"fa\", \"fa-angle-right\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"formControlName\", \"nameOnCard\", 3, \"label\"], [1, \"row\", \"mb-3\"], [1, \"col-6\"], [1, \"form-floating\"], [1, \"form-control\"], [\"cardNumber\", \"\"], [1, \"text-danger\"], [1, \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]],\n  template: function CheckoutPaymentComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵtemplate(0, CheckoutPaymentComponent_div_0_Template, 25, 3, \"div\", 0);\n      i0.ɵɵelementStart(1, \"div\", 1)(2, \"button\", 2);\n      i0.ɵɵelement(3, \"i\", 3);\n      i0.ɵɵtext(4, \" Back to review \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(5, \"button\", 4);\n      i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_Template_button_click_5_listener() {\n        return ctx.submitOrder();\n      });\n      i0.ɵɵtext(6, \" Submit order \");\n      i0.ɵɵelement(7, \"i\", 5);\n      i0.ɵɵtemplate(8, CheckoutPaymentComponent_i_8_Template, 1, 0, \"i\", 6);\n      i0.ɵɵelementEnd()();\n    }\n    if (rf & 2) {\n      i0.ɵɵproperty(\"ngIf\", ctx.checkoutForm);\n      i0.ɵɵadvance(5);\n      i0.ɵɵproperty(\"disabled\", ctx.loading || !ctx.paymentFormComplete);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"ngIf\", ctx.loading);\n    }\n  },\n  dependencies: [i5.NgIf, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i6.FormGroupName, i7.TextInputComponent, i8.CdkStepperPrevious],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsInNvdXJjZVJvb3QiOiIifQ== */\"]\n});","map":{"version":3,"mappings":"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","names":["firstValueFrom","loadStripe","i0","CheckoutPaymentComponent","constructor","basketService","checkoutService","toastr","router","ngOnInit","then","stripe","elements","cardNumber","create","mount","cardNumberElement","nativeElement","on","event","cardNumberComplete","complete","error","cardErrors","message","cardExpiry","cardExpiryElement","cardExpiryComplete","cardCvc","cardCvcElement","cardCvcComplete","paymentFormComplete","checkoutForm","get","valid","submitOrder","loading","basket","getCurrentBasketValue","createdOrder","createOrder","paymentResult","confirmPaymentWithStripe","paymentIntent","deleteBasket","a","navigationExtras","state","navigate","console","log","Error","result","confirmCardPayment","clientSecret","payment_method","card","billing_details","name","value","orderToCreate","getOrderToCreate","deliveryMethodId","shipToAddress","basketId","id","selectors","viewQuery","ctx"],"sourceRoot":"","sources":["C:\\Users\\olumi\\Desktop\\ECommerce\\client\\src\\app\\checkout\\checkout-payment\\checkout-payment.component.ts","C:\\Users\\olumi\\Desktop\\ECommerce\\client\\src\\app\\checkout\\checkout-payment\\checkout-payment.component.html"],"sourcesContent":["import { Component, ElementRef, Input, OnInit, ViewChild } from '@angular/core';\nimport { FormGroup } from '@angular/forms';\nimport { BasketService } from 'src/app/basket/basket.service';\nimport { CheckoutService } from '../checkout.service';\nimport { ToastrService } from 'ngx-toastr';\nimport { firstValueFrom } from 'rxjs';\nimport { NavigationExtras, Router } from '@angular/router';\nimport { Basket } from 'src/app/shared/models/basket';\nimport { OrderToCreate } from 'src/app/shared/models/order';\nimport { Address } from 'src/app/shared/models/user';\nimport { Stripe, StripeCardCvcElement, StripeCardExpiryElement, StripeCardNumberElement, loadStripe } from '@stripe/stripe-js';\n\n@Component({\n  selector: 'app-checkout-payment',\n  templateUrl: './checkout-payment.component.html',\n  styleUrls: ['./checkout-payment.component.scss']\n})\nexport class CheckoutPaymentComponent implements OnInit {\n  @Input() checkoutForm?: FormGroup;\n  @ViewChild('cardNumber') cardNumberElement?: ElementRef;\n  @ViewChild('cardExpiry') cardExpiryElement?: ElementRef;\n  @ViewChild('cardCvc') cardCvcElement?: ElementRef;\n  stripe: Stripe | null = null;\n  cardNumber?: StripeCardNumberElement;\n  cardExpiry?: StripeCardExpiryElement;\n  cardCvc?: StripeCardCvcElement;\n  cardNumberComplete = false;\n  cardExpiryComplete = false;\n  cardCvcComplete = false;\n  cardErrors: any;\n  loading = false;\n\n  constructor(private basketService: BasketService, private checkoutService: CheckoutService, \n      private toastr: ToastrService, private router: Router) {}\n\n  ngOnInit(): void {\n  loadStripe('pk_test_51Nc0ASDNqK1yTqV4J0A4u2HDd8sYLikpqxlr7CVA7RDM8oatAyj1RQIiwbuccTUcSYyZAitKbEZhy2k9zoXxD76X00IprdA2L6').then(stripe => {  //publishable key from stripe\n\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {\n          this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n\n        this.cardCvc = elements.create('cardCvc');\n        this.cardCvc.mount(this.cardCvcElement?.nativeElement);\n        this.cardCvc.on('change', event => {\n          this.cardCvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n      }\n    })\n  }\n\n  get paymentFormComplete() {\n    return this.checkoutForm?.get('paymentForm')?.valid \n      && this.cardNumberComplete \n      && this.cardExpiryComplete \n      && this.cardCvcComplete\n  }\n\n  async submitOrder() {\n    this.loading = true;  //loading indicator turn on\n    const basket = this.basketService.getCurrentBasketValue();\n    //if (!basket) throw new Error('cannot get basket');\n    try {\n      const createdOrder = await this.createOrder(basket);\n      const paymentResult = await this.confirmPaymentWithStripe(basket);\n      if (paymentResult.paymentIntent) {\n        this.basketService.deleteBasket(a);  //this will delete the basket from Redis and local as well\n        const navigationExtras: NavigationExtras = {state: createdOrder};\n        this.router.navigate(['checkout/success'], navigationExtras);\n      } else {\n        this.toastr.error(paymentResult.error.message);\n      }\n    } catch (error: any) {\n      console.log(error);\n      this.toastr.error(error.message)\n    } finally {\n      this.loading = false; //loading indicator turn off\n    }\n  }\n\n  private async confirmPaymentWithStripe(basket: Basket | null) {  //putting async is to guarantee it return a promise\n    if (!basket) throw new Error('Basket is null');\n    const result = this.stripe?.confirmCardPayment(basket.clientSecret!, {\n      payment_method: {\n        card: this.cardNumber!,\n        billing_details: {\n          name: this.checkoutForm?.get('paymentForm')?.get('nameOnCard')?.value\n        }\n      }\n    });\n    if (!result) throw new Error('Problem attempting payment with stripe');\n    return result;\n  }\n\n  private async createOrder(basket: Basket | null) {\n    if (!basket) throw new Error('Basket is null');\n    const orderToCreate = this.getOrderToCreate(basket);\n    return firstValueFrom(this.checkoutService.createOrder(orderToCreate));\n  }\n\n  private getOrderToCreate(basket: Basket): OrderToCreate {\n    const deliveryMethodId = this.checkoutForm?.get('deliveryForm')?.get('deliveryMethod')?.value;\n    const shipToAddress = this.checkoutForm?.get('addressForm')?.value as Address;\n    if (!deliveryMethodId || !shipToAddress) throw new Error('Problem with basket');\n    return {\n      basketId: basket.id,\n      deliveryMethodId: deliveryMethodId,\n      shipToAddress: shipToAddress\n    }\n  }\n}","<div class=\"mt-4\" *ngIf=\"checkoutForm\" [formGroup]=\"checkoutForm\">\n    <div class=\"row\">\n        <div class=\"form-group col-12\" formGroupName=\"paymentForm\">\n            <app-text-input [label]=\"'Name on card'\" formControlName=\"nameOnCard\"></app-text-input>\n        </div>\n    </div>\n    <div class=\"row mb-3\">\n        <div class=\"col-6\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardNumber></div>\n                <label>Card Number</label>\n                <span class=\"text-danger\">{{cardErrors}}</span>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardExpiry></div>\n                <label>Card Expiry</label>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardCvc></div>\n                <label>Card CVC</label>\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class=\"d-flex justify-content-between flex-row mt-3\">\n    <button class=\"btn btn-outline-primary\" cdkStepperPrevious>\n        <i class=\"fa fa-angle-left\"></i> Back to review\n    </button>\n    <button [disabled]=\"loading || !paymentFormComplete\" class=\"btn btn-primary\" (click)=\"submitOrder()\">\n        Submit order <i class=\"fa fa-angle-right\"></i>\n        <i *ngIf=\"loading\" class=\"fa fa-spinner fa-spin\"></i> \n    </button>\n</div>"]},"metadata":{},"sourceType":"module","externalDependencies":[]}