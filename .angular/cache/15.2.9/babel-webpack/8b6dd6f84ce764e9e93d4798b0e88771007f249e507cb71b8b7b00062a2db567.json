{"ast":null,"code":"import { BehaviorSubject, map } from 'rxjs';\nimport { environment } from 'src/environments/environment';\nimport { Basket } from '../shared/models/basket';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class BasketService {\n  constructor(http) {\n    this.http = http;\n    this.baseUrl = environment.apiUrl;\n    this.basketSource = new BehaviorSubject(null); //this null means that when our app first start up b4 we done anything, we are not going to hv a basket and it will be null. other component will not hv access to this thats why its private. you can only update this from inside our service\n    this.basketSource$ = this.basketSource.asObservable(); //our component will be able to subscribe to this and get the info they want\n    this.basketTotalSource = new BehaviorSubject(null);\n    this.basketTotalSource$ = this.basketTotalSource.asObservable();\n  }\n  createPaymentIntent() {\n    return this.http.post(this.baseUrl + 'payments/' + this.getCurrentBasketValue()?.id, {}).pipe(map(basket => {\n      this.basketSource.next(basket);\n      console.log(basket);\n    }));\n  }\n  setShippingPrice(deliveryMethod) {\n    const basket = this.getCurrentBasketValue();\n    this.shipping = deliveryMethod.price;\n    if (basket) {\n      basket.deliveryMethodId = deliveryMethod.id;\n      this.setBasket(basket);\n    }\n  }\n  getBasket(id) {\n    return this.http.get(this.baseUrl + 'basket?id=' + id).subscribe({\n      next: basket => {\n        this.basketSource.next(basket);\n        this.calculateTotals();\n      }\n    });\n  }\n  setBasket(basket) {\n    return this.http.post(this.baseUrl + 'basket', basket).subscribe({\n      next: basket => {\n        this.basketSource.next(basket);\n        this.calculateTotals();\n      }\n    });\n  }\n  getCurrentBasketValue() {\n    return this.basketSource.value;\n  }\n  addItemToBasket(item, quantity = 1) {\n    if (this.isProduct(item)) item = this.mapProductItemToBasketItem(item); //type guard is used here referencing isProduct below\n    console.log(item);\n    const basket = this.getCurrentBasketValue() ?? this.createBasket();\n    basket.items = this.addOrUpdateItem(basket.items, item, quantity);\n    this.setBasket(basket);\n  }\n  removeItemFromBasket(id, quantity = 1) {\n    const basket = this.getCurrentBasketValue();\n    if (!basket) return; //if basket is empty, return nothing\n    const item = basket.items.find(x => x.id === id);\n    if (item) {\n      item.quantity -= quantity; //decrement\n      if (item.quantity === 0) {\n        //if its now equal to 0 after the decrement\n        basket.items = basket.items.filter(x => x.id !== id);\n      }\n      if (basket.items.length > 0) this.setBasket(basket);else this.deleteBasket(basket);\n    }\n  }\n  deleteBasket(basket) {\n    return this.http.delete(this.baseUrl + 'basket?id=' + basket.id).subscribe({\n      next: () => {\n        this.deleteLocalBasket();\n      }\n    });\n  }\n  deleteLocalBasket() {\n    this.basketSource.next(null);\n    this.basketTotalSource.next(null);\n    localStorage.removeItem('basket_id');\n  }\n  addOrUpdateItem(items, itemToAdd, quantity) {\n    const item = items.find(x => x.id === itemToAdd.id);\n    if (item) item.quantity += quantity; //increase the quantity if we have item in our basket\n    else {\n      itemToAdd.quantity = quantity;\n      items.push(itemToAdd);\n    }\n    return items;\n  }\n  createBasket() {\n    const basket = new Basket();\n    localStorage.setItem('basket_id', basket.id);\n    return basket;\n  }\n  mapProductItemToBasketItem(item) {\n    return {\n      id: item.id,\n      productName: item.name,\n      price: item.price,\n      quantity: 0,\n      pictureUrl: item.pictureUrl,\n      brand: item.productBrand,\n      type: item.productType\n    };\n  }\n  calculateTotals() {\n    const basket = this.getCurrentBasketValue();\n    if (!basket) return;\n    const subtotal = basket.items.reduce((a, b) => b.price * b.quantity + a, 0); //where a = previous value, b = current value. Any letter can be used for rep.\n    const total = subtotal + this.shipping;\n    this.basketTotalSource.next({\n      shipping: this.shipping,\n      total,\n      subtotal\n    });\n  }\n  isProduct(item) {\n    return item.productBrand !== undefined;\n  }\n}\nBasketService.ɵfac = function BasketService_Factory(t) {\n  return new (t || BasketService)(i0.ɵɵinject(i1.HttpClient));\n};\nBasketService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: BasketService,\n  factory: BasketService.ɵfac,\n  providedIn: 'root'\n});","map":{"version":3,"mappings":"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","names":["BehaviorSubject","map","environment","Basket","BasketService","constructor","http","apiUrl","basketSource","asObservable","basketTotalSource","createPaymentIntent","post","baseUrl","getCurrentBasketValue","id","pipe","basket","next","console","log","setShippingPrice","deliveryMethod","shipping","price","deliveryMethodId","setBasket","getBasket","get","subscribe","calculateTotals","value","addItemToBasket","item","quantity","isProduct","mapProductItemToBasketItem","createBasket","items","addOrUpdateItem","removeItemFromBasket","find","x","filter","length","deleteBasket","delete","deleteLocalBasket","localStorage","removeItem","itemToAdd","push","setItem","productName","name","pictureUrl","brand","productBrand","type","productType","subtotal","reduce","a","b","total","undefined","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\olumi\\Desktop\\ECommerce\\client\\src\\app\\basket\\basket.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { BehaviorSubject, map } from 'rxjs';\nimport { environment } from 'src/environments/environment';\nimport { Basket, BasketItem, BasketTotals } from '../shared/models/basket';\nimport { HttpClient } from '@angular/common/http';\nimport { Product } from '../shared/models/product';\nimport { DeliveryMethod } from '../shared/models/deliveryMethod';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class BasketService {\n  baseUrl = environment.apiUrl;\n  private basketSource = new BehaviorSubject<Basket | null>(null);//this null means that when our app first start up b4 we done anything, we are not going to hv a basket and it will be null. other component will not hv access to this thats why its private. you can only update this from inside our service\n  basketSource$ = this.basketSource.asObservable(); //our component will be able to subscribe to this and get the info they want\n  private basketTotalSource = new BehaviorSubject<BasketTotals | null>(null);\n  basketTotalSource$ = this.basketTotalSource.asObservable();\n\n  constructor(private http: HttpClient) { }\n\n  createPaymentIntent() {\n    return this.http.post<Basket>(this.baseUrl + 'payments/' + this.getCurrentBasketValue()?.id, {})\n      .pipe(\n        map(basket => {\n          this.basketSource.next(basket);\n          console.log(basket);\n        })\n      )\n  }\n\n   setShippingPrice(deliveryMethod: DeliveryMethod) {\n    const basket = this.getCurrentBasketValue();\n    this.shipping = deliveryMethod.price;\n    if (basket) {\n      basket.deliveryMethodId = deliveryMethod.id;\n      this.setBasket(basket);\n    }\n   }\n\n  getBasket(id: string) {\n    return this.http.get<Basket>(this.baseUrl + 'basket?id=' + id).subscribe({\n      next: basket => {\n        this.basketSource.next(basket);\n        this.calculateTotals();\n      }\n    })\n  }\n\n  setBasket(basket: Basket) {\n    return this.http.post<Basket>(this.baseUrl + 'basket', basket).subscribe({\n      next: basket => {\n        this.basketSource.next(basket);\n        this.calculateTotals();\n\n      }\n    })\n  }\n\n  getCurrentBasketValue() {  // this will give us the value of the basket\n    return this.basketSource.value;\n  }\n\n  addItemToBasket(item: Product | BasketItem, quantity = 1) {  //Either you add from the product page or from the basket. Basket is expecting BasketItems not Product.Therefore wil have to map the properties from one to another.c# uses Auto mapper, but in angular will create a class for the mapping\n    if (this.isProduct(item)) item = this.mapProductItemToBasketItem(item);  //type guard is used here referencing isProduct below\n    console.log(item);\n    const basket = this.getCurrentBasketValue() ?? this.createBasket();\n    basket.items = this.addOrUpdateItem(basket.items, item, quantity);\n    this.setBasket(basket);\n  }\n\n   removeItemFromBasket(id: number, quantity = 1) {\n    const basket = this.getCurrentBasketValue();\n    if (!basket) return; //if basket is empty, return nothing\n    const item = basket.items.find(x => x.id === id);\n    if (item) {\n      item.quantity -= quantity; //decrement\n      if (item.quantity === 0) { //if its now equal to 0 after the decrement\n        basket.items = basket.items.filter(x => x.id !== id);\n      }\n      if (basket.items.length > 0) this.setBasket(basket);\n      else this.deleteBasket(basket);\n    }\n  }\n\n  deleteBasket(basket: Basket) {\n    return this.http.delete(this.baseUrl + 'basket?id=' + basket.id).subscribe({\n      next: () => {\n        this.deleteLocalBasket();\n      }\n    })\n  }\n\n  deleteLocalBasket() {     //this will delete the basket locally after the order hv been submitted.\n    this.basketSource.next(null);\n    this.basketTotalSource.next(null);\n    localStorage.removeItem('basket_id');\n  }\n\n  private addOrUpdateItem(items: BasketItem[], itemToAdd: BasketItem, quantity: number): BasketItem[] {// private becos we are not using it outside this service\n    const item = items.find(x => x.id === itemToAdd.id);\n    if (item) item.quantity += quantity; //increase the quantity if we have item in our basket\n    else {\n      itemToAdd.quantity = quantity;\n      items.push(itemToAdd);\n    }\n    return items;\n  }\n\n  private createBasket(): Basket { // private becos we are not using it outside this service\n    const basket = new Basket();\n    localStorage.setItem('basket_id', basket.id);\n    return basket;\n  }\n\n  private mapProductItemToBasketItem(item: Product): BasketItem {\n    return { //mapping one properties to another\n      id: item.id,\n      productName: item.name,\n      price: item.price,\n      quantity: 0,\n      pictureUrl: item.pictureUrl,\n      brand: item.productBrand,\n      type: item.productType\n    }\n  }\n\n  private calculateTotals() {\n    const basket = this.getCurrentBasketValue();\n    if (!basket) return;\n    const subtotal = basket.items.reduce((a, b) => (b.price * b.quantity) + a, 0); //where a = previous value, b = current value. Any letter can be used for rep.\n    const total = subtotal + this.shipping;\n    this.basketTotalSource.next({ shipping: this.shipping, total, subtotal });\n  }\n\n  private isProduct(item: Product | BasketItem): item is Product {\n    return (item as Product).productBrand !== undefined;\n  }\n}\n\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}