{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/olumi/Desktop/ECommerce/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { firstValueFrom } from 'rxjs';\nimport { loadStripe } from '@stripe/stripe-js';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/basket/basket.service\";\nimport * as i2 from \"../checkout.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"../../shared/components/text-input/text-input.component\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\nfunction CheckoutPaymentComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 7)(1, \"div\", 8)(2, \"div\", 9);\n    i0.ɵɵelement(3, \"app-text-input\", 10);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 11)(5, \"div\", 12)(6, \"div\", 13);\n    i0.ɵɵelement(7, \"div\", 14, 15);\n    i0.ɵɵelementStart(9, \"label\");\n    i0.ɵɵtext(10, \"Card Number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"span\", 16);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 17)(14, \"div\", 13);\n    i0.ɵɵelement(15, \"div\", 14, 18);\n    i0.ɵɵelementStart(17, \"label\");\n    i0.ɵɵtext(18, \"Card Expiry\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(19, \"div\", 17)(20, \"div\", 13);\n    i0.ɵɵelement(21, \"div\", 14, 19);\n    i0.ɵɵelementStart(23, \"label\");\n    i0.ɵɵtext(24, \"Card CVC\");\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.checkoutForm);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"label\", \"Name on card\");\n    i0.ɵɵadvance(9);\n    i0.ɵɵtextInterpolate(ctx_r0.cardErrors);\n  }\n}\nfunction CheckoutPaymentComponent_i_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"i\", 20);\n  }\n}\nexport let CheckoutPaymentComponent = /*#__PURE__*/(() => {\n  class CheckoutPaymentComponent {\n    constructor(basketService, checkoutService, toastr, router) {\n      this.basketService = basketService;\n      this.checkoutService = checkoutService;\n      this.toastr = toastr;\n      this.router = router;\n      this.stripe = null;\n      this.cardNumberComplete = false;\n      this.cardExpiryComplete = false;\n      this.cardCvcComplete = false;\n      this.loading = false;\n    }\n    ngOnInit() {\n      loadStripe('pk_test_51Nc0ASDNqK1yTqV4J0A4u2HDd8sYLikpqxlr7CVA7RDM8oatAyj1RQIiwbuccTUcSYyZAitKbEZhy2k9zoXxD76X00IprdA2L6').then(stripe => {\n        this.stripe = stripe;\n        const elements = stripe?.elements();\n        if (elements) {\n          this.cardNumber = elements.create('cardNumber');\n          this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n          this.cardNumber.on('change', event => {\n            this.cardNumberComplete = event.complete;\n            if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n          });\n          this.cardExpiry = elements.create('cardExpiry');\n          this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n          this.cardExpiry.on('change', event => {\n            this.cardExpiryComplete = event.complete;\n            if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n          });\n          this.cardCvc = elements.create('cardCvc');\n          this.cardCvc.mount(this.cardCvcElement?.nativeElement);\n          this.cardCvc.on('change', event => {\n            this.cardCvcComplete = event.complete;\n            if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n          });\n        }\n      });\n    }\n    get paymentFormComplete() {\n      return this.checkoutForm?.get('paymentForm')?.valid && this.cardNumberComplete && this.cardExpiryComplete && this.cardCvcComplete;\n    }\n    submitOrder() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        _this.loading = true; //loading indicator turn on\n        const basket = _this.basketService.getCurrentBasketValue();\n        if (!basket) throw new Error('cannot get basket');\n        try {\n          const createdOrder = yield _this.createOrder(basket);\n          const paymentResult = yield _this.confirmPaymentWithStripe(basket);\n          if (paymentResult.paymentIntent) {\n            _this.basketService.deleteBasket(basket); //this will delete the basket from Redis and local as well\n            const navigationExtras = {\n              state: createdOrder\n            };\n            _this.router.navigate(['checkout/success'], navigationExtras);\n          } else {\n            _this.toastr.error(paymentResult.error.message);\n          }\n        } catch (error) {\n          console.log(error);\n          _this.toastr.error(error.message);\n        } finally {\n          _this.loading = false; //loading indicator turn off\n        }\n      })();\n    }\n\n    confirmPaymentWithStripe(basket) {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!basket) throw new Error('Basket is null');\n        const result = _this2.stripe?.confirmCardPayment(basket.clientSecret, {\n          payment_method: {\n            card: _this2.cardNumber,\n            billing_details: {\n              name: _this2.checkoutForm?.get('paymentForm')?.get('nameOnCard')?.value\n            }\n          }\n        });\n        if (!result) throw new Error('Problem attempting payment with stripe');\n        return result;\n      })();\n    }\n    createOrder(basket) {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        if (!basket) throw new Error('Basket is null');\n        const orderToCreate = _this3.getOrderToCreate(basket);\n        return firstValueFrom(_this3.checkoutService.createOrder(orderToCreate));\n      })();\n    }\n    getOrderToCreate(basket) {\n      const deliveryMethodId = this.checkoutForm?.get('deliveryForm')?.get('deliveryMethod')?.value;\n      const shipToAddress = this.checkoutForm?.get('addressForm')?.value;\n      if (!deliveryMethodId || !shipToAddress) throw new Error('Problem with basket');\n      return {\n        basketId: basket.id,\n        deliveryMethodId: deliveryMethodId,\n        shipToAddress: shipToAddress\n      };\n    }\n  }\n  CheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n    return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n  };\n  CheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: CheckoutPaymentComponent,\n    selectors: [[\"app-checkout-payment\"]],\n    viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(_c0, 5);\n        i0.ɵɵviewQuery(_c1, 5);\n        i0.ɵɵviewQuery(_c2, 5);\n      }\n      if (rf & 2) {\n        let _t;\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardCvcElement = _t.first);\n      }\n    },\n    inputs: {\n      checkoutForm: \"checkoutForm\"\n    },\n    decls: 9,\n    vars: 3,\n    consts: [[\"class\", \"mt-4\", 3, \"formGroup\", 4, \"ngIf\"], [1, \"d-flex\", \"justify-content-between\", \"flex-row\", \"mt-3\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-outline-primary\"], [1, \"fa\", \"fa-angle-left\"], [1, \"btn\", \"btn-primary\", 3, \"disabled\", \"click\"], [1, \"fa\", \"fa-angle-right\"], [\"class\", \"fa fa-spinner fa-spin\", 4, \"ngIf\"], [1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"formControlName\", \"nameOnCard\", 3, \"label\"], [1, \"row\", \"mb-3\"], [1, \"col-6\"], [1, \"form-floating\"], [1, \"form-control\"], [\"cardNumber\", \"\"], [1, \"text-danger\"], [1, \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"], [1, \"fa\", \"fa-spinner\", \"fa-spin\"]],\n    template: function CheckoutPaymentComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵtemplate(0, CheckoutPaymentComponent_div_0_Template, 25, 3, \"div\", 0);\n        i0.ɵɵelementStart(1, \"div\", 1)(2, \"button\", 2);\n        i0.ɵɵelement(3, \"i\", 3);\n        i0.ɵɵtext(4, \" Back to review \");\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementStart(5, \"button\", 4);\n        i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_Template_button_click_5_listener() {\n          return ctx.submitOrder();\n        });\n        i0.ɵɵtext(6, \" Submit order \");\n        i0.ɵɵelement(7, \"i\", 5);\n        i0.ɵɵtemplate(8, CheckoutPaymentComponent_i_8_Template, 1, 0, \"i\", 6);\n        i0.ɵɵelementEnd()();\n      }\n      if (rf & 2) {\n        i0.ɵɵproperty(\"ngIf\", ctx.checkoutForm);\n        i0.ɵɵadvance(5);\n        i0.ɵɵproperty(\"disabled\", ctx.loading || !ctx.paymentFormComplete);\n        i0.ɵɵadvance(3);\n        i0.ɵɵproperty(\"ngIf\", ctx.loading);\n      }\n    },\n    dependencies: [i5.NgIf, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i6.FormGroupName, i7.TextInputComponent, i8.CdkStepperPrevious]\n  });\n  return CheckoutPaymentComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}