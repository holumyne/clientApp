{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/olumi/Desktop/ECommerce/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { loadStripe } from '@stripe/stripe-js';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/basket/basket.service\";\nimport * as i2 from \"../checkout.service\";\nimport * as i3 from \"ngx-toastr\";\nimport * as i4 from \"@angular/router\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"../../shared/components/text-input/text-input.component\";\nimport * as i8 from \"@angular/cdk/stepper\";\nconst _c0 = [\"cardNumber\"];\nconst _c1 = [\"cardExpiry\"];\nconst _c2 = [\"cardCvc\"];\nfunction CheckoutPaymentComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 6)(1, \"div\", 7)(2, \"div\", 8);\n    i0.ɵɵelement(3, \"app-text-input\", 9);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(4, \"div\", 10)(5, \"div\", 11)(6, \"div\", 12);\n    i0.ɵɵelement(7, \"div\", 13, 14);\n    i0.ɵɵelementStart(9, \"label\");\n    i0.ɵɵtext(10, \"Card Number\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"span\", 15);\n    i0.ɵɵtext(12);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 16)(14, \"div\", 12);\n    i0.ɵɵelement(15, \"div\", 13, 17);\n    i0.ɵɵelementStart(17, \"label\");\n    i0.ɵɵtext(18, \"Card Expiry\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(19, \"div\", 16)(20, \"div\", 12);\n    i0.ɵɵelement(21, \"div\", 13, 18);\n    i0.ɵɵelementStart(23, \"label\");\n    i0.ɵɵtext(24, \"Card CVC\");\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.checkoutForm);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"label\", \"Name on card\");\n    i0.ɵɵadvance(9);\n    i0.ɵɵtextInterpolate(ctx_r0.cardErrors);\n  }\n}\nexport class CheckoutPaymentComponent {\n  constructor(basketService, checkoutService, toastr, router) {\n    this.basketService = basketService;\n    this.checkoutService = checkoutService;\n    this.toastr = toastr;\n    this.router = router;\n    this.stripe = null;\n    this.loading = false;\n  }\n  ngOnInit() {\n    loadStripe('pk_test_51Nc0ASDNqK1yTqV4J0A4u2HDd8sYLikpqxlr7CVA7RDM8oatAyj1RQIiwbuccTUcSYyZAitKbEZhy2k9zoXxD76X00IprdA2L6').then(stripe => {\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {\n          // this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          // this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n        this.cardCvc = elements.create('cardCvc');\n        this.cardCvc.mount(this.cardCvcElement?.nativeElement);\n        this.cardCvc.on('change', event => {\n          // this.cardCvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;else this.cardErrors = null;\n        });\n      }\n    });\n  }\n  submitOrder() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      _this.loading = true;\n      const basket = _this.basketService.getCurrentBasketValue();\n      // if (!basket) throw new Error('cannot get basket');\n      try {\n        const createdOrder = _this.createOrder(basket);\n        const paymentResult = yield _this.confirmPaymentWithStripe(basket);\n        if (paymentResult.paymentIntent) {\n          _this.basketService.deleteBasket(basket);\n          const navigationExtras = {\n            state: createdOrder\n          };\n          _this.router.navigate(['checkout/success'], navigationExtras);\n        } else {\n          _this.toastr.error(paymentResult.error.message);\n        }\n      } catch (error) {\n        console.log(error);\n        _this.toastr.error(error.message);\n      } finally {\n        _this.loading = false;\n      }\n    })();\n  }\n  createOrder(basket) {\n    if (!basket) throw new Error('Basket is null');\n    // const orderToCreate = this.getOrderToCreate(basket);\n    // return firstValueFrom(this.checkoutService.createOrder(orderToCreate));\n  }\n\n  getOrderToCreate(basket) {\n    const deliveryMethodId = this.checkoutForm?.get('deliveryForm')?.get('deliveryMethod')?.value;\n    const shipToAddress = this.checkoutForm?.get('addressForm')?.value;\n    if (!deliveryMethodId || !shipToAddress) return;\n    return {\n      basketId: basket.id,\n      deliveryMethodId: deliveryMethodId,\n      shipToAddress: shipToAddress\n    };\n  }\n}\nCheckoutPaymentComponent.ɵfac = function CheckoutPaymentComponent_Factory(t) {\n  return new (t || CheckoutPaymentComponent)(i0.ɵɵdirectiveInject(i1.BasketService), i0.ɵɵdirectiveInject(i2.CheckoutService), i0.ɵɵdirectiveInject(i3.ToastrService), i0.ɵɵdirectiveInject(i4.Router));\n};\nCheckoutPaymentComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: CheckoutPaymentComponent,\n  selectors: [[\"app-checkout-payment\"]],\n  viewQuery: function CheckoutPaymentComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n      i0.ɵɵviewQuery(_c1, 5);\n      i0.ɵɵviewQuery(_c2, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardNumberElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardExpiryElement = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.cardCvcElement = _t.first);\n    }\n  },\n  inputs: {\n    checkoutForm: \"checkoutForm\"\n  },\n  decls: 8,\n  vars: 1,\n  consts: [[\"class\", \"mt-4\", 3, \"formGroup\", 4, \"ngIf\"], [1, \"d-flex\", \"justify-content-between\", \"flex-row\", \"mt-3\"], [\"cdkStepperPrevious\", \"\", 1, \"btn\", \"btn-outline-primary\"], [1, \"fa\", \"fa-angle-left\"], [1, \"btn\", \"btn-primary\", 3, \"click\"], [1, \"fa\", \"fa-angle-right\"], [1, \"mt-4\", 3, \"formGroup\"], [1, \"row\"], [\"formGroupName\", \"paymentForm\", 1, \"form-group\", \"col-12\"], [\"formControlName\", \"nameOnCard\", 3, \"label\"], [1, \"row\", \"mb-3\"], [1, \"col-6\"], [1, \"form-floating\"], [1, \"form-control\"], [\"cardNumber\", \"\"], [1, \"text-danger\"], [1, \"col-3\"], [\"cardExpiry\", \"\"], [\"cardCvc\", \"\"]],\n  template: function CheckoutPaymentComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵtemplate(0, CheckoutPaymentComponent_div_0_Template, 25, 3, \"div\", 0);\n      i0.ɵɵelementStart(1, \"div\", 1)(2, \"button\", 2);\n      i0.ɵɵelement(3, \"i\", 3);\n      i0.ɵɵtext(4, \" Back to review \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(5, \"button\", 4);\n      i0.ɵɵlistener(\"click\", function CheckoutPaymentComponent_Template_button_click_5_listener() {\n        return ctx.submitOrder();\n      });\n      i0.ɵɵtext(6, \" Submit order \");\n      i0.ɵɵelement(7, \"i\", 5);\n      i0.ɵɵelementEnd()();\n    }\n    if (rf & 2) {\n      i0.ɵɵproperty(\"ngIf\", ctx.checkoutForm);\n    }\n  },\n  dependencies: [i5.NgIf, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i6.FormGroupName, i7.TextInputComponent, i8.CdkStepperPrevious],\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsInNvdXJjZVJvb3QiOiIifQ== */\"]\n});","map":{"version":3,"mappings":"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","names":["loadStripe","i0","CheckoutPaymentComponent","constructor","basketService","checkoutService","toastr","router","ngOnInit","then","stripe","elements","cardNumber","create","mount","cardNumberElement","nativeElement","on","event","error","cardErrors","message","cardExpiry","cardExpiryElement","cardCvc","cardCvcElement","submitOrder","loading","basket","getCurrentBasketValue","createdOrder","createOrder","paymentResult","confirmPaymentWithStripe","paymentIntent","deleteBasket","navigationExtras","state","navigate","console","log","Error","getOrderToCreate","deliveryMethodId","checkoutForm","get","value","shipToAddress","basketId","id","selectors","viewQuery","ctx"],"sourceRoot":"","sources":["C:\\Users\\olumi\\Desktop\\ECommerce\\client\\src\\app\\checkout\\checkout-payment\\checkout-payment.component.ts","C:\\Users\\olumi\\Desktop\\ECommerce\\client\\src\\app\\checkout\\checkout-payment\\checkout-payment.component.html"],"sourcesContent":["import { Component, ElementRef, Input, OnInit, ViewChild } from '@angular/core';\nimport { FormGroup } from '@angular/forms';\nimport { BasketService } from 'src/app/basket/basket.service';\nimport { CheckoutService } from '../checkout.service';\nimport { ToastrService } from 'ngx-toastr';\nimport { NavigationExtras, Router } from '@angular/router';\nimport { Basket } from 'src/app/shared/models/basket';\nimport { OrderToCreate } from 'src/app/shared/models/order';\nimport { Address } from 'src/app/shared/models/user';\nimport { Stripe, StripeCardCvcElement, StripeCardExpiryElement, StripeCardNumberElement, loadStripe } from '@stripe/stripe-js';\n\n@Component({\n  selector: 'app-checkout-payment',\n  templateUrl: './checkout-payment.component.html',\n  styleUrls: ['./checkout-payment.component.scss']\n})\nexport class CheckoutPaymentComponent implements OnInit {\n  @Input() checkoutForm?: FormGroup;\n  @ViewChild('cardNumber') cardNumberElement?: ElementRef;\n  @ViewChild('cardExpiry') cardExpiryElement?: ElementRef;\n  @ViewChild('cardCvc') cardCvcElement?: ElementRef;\n  stripe: Stripe | null = null;\n  cardNumber?: StripeCardNumberElement;\n  cardExpiry?: StripeCardExpiryElement;\n  cardCvc?: StripeCardCvcElement;\n  // cardNumberComplete = false;\n  // cardExpiryComplete = false;\n  // cardCvcComplete = false;\n  cardErrors: any;\n  loading = false;\n\n\n  constructor(private basketService: BasketService, private checkoutService: CheckoutService,\n    private toastr: ToastrService, private router: Router) { }\n\n  ngOnInit(): void {\n    loadStripe('pk_test_51Nc0ASDNqK1yTqV4J0A4u2HDd8sYLikpqxlr7CVA7RDM8oatAyj1RQIiwbuccTUcSYyZAitKbEZhy2k9zoXxD76X00IprdA2L6').then(stripe => {  //publishable key from stripe\n      this.stripe = stripe;\n      const elements = stripe?.elements();\n      if (elements) {\n        this.cardNumber = elements.create('cardNumber');\n        this.cardNumber.mount(this.cardNumberElement?.nativeElement);\n        this.cardNumber.on('change', event => {  //this is to display error if user supply wrong digit\n          // this.cardNumberComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n\n        this.cardExpiry = elements.create('cardExpiry');\n        this.cardExpiry.mount(this.cardExpiryElement?.nativeElement);\n        this.cardExpiry.on('change', event => {\n          // this.cardExpiryComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n\n        this.cardCvc = elements.create('cardCvc');\n        this.cardCvc.mount(this.cardCvcElement?.nativeElement);\n        this.cardCvc.on('change', event => {\n          // this.cardCvcComplete = event.complete;\n          if (event.error) this.cardErrors = event.error.message;\n          else this.cardErrors = null;\n        })\n      }\n    })\n  }\n\n  async submitOrder() {\n    this.loading = true;\n    const basket = this.basketService.getCurrentBasketValue();\n    // if (!basket) throw new Error('cannot get basket');\n    try {\n      const createdOrder =  this.createOrder(basket);\n      const paymentResult = await this.confirmPaymentWithStripe(basket);\n      if (paymentResult.paymentIntent) {\n        this.basketService.deleteBasket(basket);\n        const navigationExtras: NavigationExtras = {state: createdOrder};\n        this.router.navigate(['checkout/success'], navigationExtras);\n      } else {\n        this.toastr.error(paymentResult.error.message);\n      }\n    } catch (error: any) {\n      console.log(error);\n      this.toastr.error(error.message)\n    } finally {\n      this.loading = false;\n    }\n  }\n  private createOrder(basket: Basket | null) {\n    if (!basket) throw new Error('Basket is null');\n    // const orderToCreate = this.getOrderToCreate(basket);\n    // return firstValueFrom(this.checkoutService.createOrder(orderToCreate));\n  }\n\n  private getOrderToCreate(basket: Basket) {\n    const deliveryMethodId = this.checkoutForm?.get('deliveryForm')?.get('deliveryMethod')?.value;\n    const shipToAddress = this.checkoutForm?.get('addressForm')?.value as Address;\n    if (!deliveryMethodId || !shipToAddress) return;\n    return {\n      basketId: basket.id,\n      deliveryMethodId: deliveryMethodId,\n      shipToAddress: shipToAddress\n    }\n  }\n}\n","<div class=\"mt-4\" *ngIf=\"checkoutForm\" [formGroup]=\"checkoutForm\">\n    <div class=\"row\">\n        <div class=\"form-group col-12\" formGroupName=\"paymentForm\">\n            <app-text-input [label]=\"'Name on card'\" formControlName=\"nameOnCard\"></app-text-input>\n        </div>\n    </div>\n    <div class=\"row mb-3\">\n        <div class=\"col-6\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardNumber></div>\n                <label>Card Number</label>\n                <span class=\"text-danger\">{{cardErrors}}</span>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardExpiry></div>\n                <label>Card Expiry</label>\n            </div>\n        </div>\n        <div class=\"col-3\">\n            <div class=\"form-floating\">\n                <div class=\"form-control\" #cardCvc></div>\n                <label>Card CVC</label>\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class=\"d-flex justify-content-between flex-row mt-3\">\n    <button class=\"btn btn-outline-primary\" cdkStepperPrevious>\n        <i class=\"fa fa-angle-left\"></i> Back to review\n    </button>\n    <button class=\"btn btn-primary\" (click)=\"submitOrder()\">\n        Submit order <i class=\"fa fa-angle-right\"></i> \n    </button>\n</div>"]},"metadata":{},"sourceType":"module","externalDependencies":[]}